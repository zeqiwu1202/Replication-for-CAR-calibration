est_cal_rfnn_g = rep(0,S)
sd_cal_rfnn_g = rep(0,S)
for (s in 1:S){
print(s)
if (randomization_method == "PS") {
data = FUN(n,alpha0,alpha1,betavec0,betavec1,pi,sigma0,sigma1,p, weight,lambda)
}
else {
data = FUN(n,alpha0,alpha1,betavec0,betavec1,pi,sigma0,sigma1,p)
}
result = cal_rf_nn(data)
sd_cal_rf[s] = result$sd[1]
sd_cal_nn[s] = result$sd[2]
sd_cal_rfnn[s] = result$sd[3]
est_cal_rf[s] = result$est[1]
est_cal_nn[s] = result$est[2]
est_cal_rfnn[s] = result$est[3]
est_DML_nn[s] = result$est[5]
est_DML_rf[s] = result$est[4]
sd_DML_nn[s] = result$sd[5]
sd_DML_rf[s] = result$sd[4]
#est_dim[s] = mean(data$Y[data$A == 1]) - mean(data$Y[data$A == 0])
est_sdim[s] = result$est[6]
sd_sdim[s] = result$sd[6]
est_cal_rf_g[s] = result$est[7]
sd_cal_rf_g[s] = result$sd[7]
est_cal_nn_g[s] = result$est[8]
sd_cal_nn_g[s] = result$sd[8]
est_cal_rfnn_g[s] = result$est[9]
sd_cal_rfnn_g[s] = result$sd[9]
}
true_value = trueval(Model,alpha0,alpha1,betavec0,betavec1)
data_list <- list(est_cal_rf, est_cal_nn,est_cal_rfnn,
est_DML_nn, est_DML_rf, est_sdim,
est_cal_rf_g,est_cal_nn_g,est_cal_rfnn_g)
sd_data_list <- list(sd_cal_rf, sd_cal_nn,sd_cal_rfnn,
sd_DML_nn, sd_DML_rf, sd_sdim,
sd_cal_rf_g,sd_cal_nn_g,sd_cal_rfnn_g)
names = c("cal_rf", "cal_nn","cal_rfnn",
"AIPW_nn", "AIPW_rf", "sdim", "cal_rf_g","cal_nn_g","cal_rfnn_g")
file_name = sprintf("20250912_%s_n%s_%s.pdf", Model, n, randomization_method)
pdf(file_name, width = 10, height = 8)
boxplot(data_list, names=names, main = "Comparison of the Methods",
col = c("skyblue", "lightgreen", "lightpink", "lightyellow", "lightcoral","lightsalmon","lavender",
"lightseagreen","lightsteelblue","peachpuff"))
abline(h = true_value, col = "black", lty = 2,lwd=3)
legend("topright", legend = "Real Effect", col = "black", lty = 2, box.lwd = 0,lwd=3)
dev.off()
m = length(names)
df = data.frame(RMSE=rep(0,m), Bias=rep(0,m), SD=rep(0,m), SE=rep(0,m), CP=rep(0,m))
for (i in 1:length(names)){
df$Bias[i] = abs(mean(unlist(data_list[i]))-true_value)
print(paste("absolute error: ",names[i],": ",df$Bias[i],sep = ''))
}
for (i in 1:length(names)){
df$SD[i] = sd(unlist(data_list[i]))
print(paste("sd:",names[i],": ",df$SD[i],sep = ''))
}
for (i in 1:length(names)){
df$SE[i] = mean(unlist(sd_data_list[i]))
print(paste("estimated sd:",names[i],": ",df$SE[i],sep = ''))
}
for (i in 1:length(names)){
df$CP[i] = calculate_CP(true_value, unlist(data_list[i]), unlist(sd_data_list[i]))
print(paste("coverage probability:",names[i],": ",df$CP[i], sep = ''))
}
for (i in 1:length(names)){
df$RMSE[i] = mean((unlist(data_list[i])-true_value)^2)^0.5
print(paste("RMSE: ",names[i],": ",df$RMSE[i],sep = ''))
}
df$Bias <-round(df$Bias,3)
return(df)
}
final_df_list <- list()
randomization_methods = c("SRS","SBR","PS")
for (j in 1:3) {
df = run_simulation("Model6", 1000, randomization_methods[j])
final_df_list[[j]] <- df
}
final_df <- bind_cols(final_df_list)
print(final_df, digits=3, row.names = FALSE)
library(pls)
library(mda)
library(splines)
library(randomForest)
library(caret)
library(dplyr)
library(MASS)
library(glmnet)
library(kernlab)
library(nnet)
library(gbm)
library(rpart)
library(caretEnsemble)
library(elasticnet)
library(np)
library(earth)
library(neuralnet)
library(carat)
Rcpp::sourceCpp("vestimator.cpp")
source("estimators.R")
source("cal_estimator.R")
source("calibration.R")
source("createFolds_by_strat.R")
source("Model1.R")
source("Model2.R")
source("Model3.R")
source("Model4.R")
source("Model5.R")
source("Model6.R")
source("Model7.R")
source("Model8.R")
source("tables.R")
source("DML.R")
source("parallel.R")
RNGkind("L'Ecuyer-CMRG")
set.seed(0)
# mc.reset.stream()
run_simulation<- function(Model, n, randomization_method){
# Model = "Model8"
# Model = "Model5"
# n=500
#randomization_method = "SRS"
alpha0 = 1
alpha1 = 4
betavec0 = c(75,35,125,80)
betavec1 = c(100,80,60,40)
FUN = sim_fun(Model,randomization_method)
lambda = 0.75
weight = 1
omega = c(0.1,0.1,0.4,0.4)
sigma1 = 3
sigma0 = 1
pi = 0.5
p=30
S=300
sd_cal_rf = rep(0,S)
sd_cal_nn = rep(0,S)
sd_cal_rfnn = rep(0,S)
sd_DML_nn = rep(0,S)
sd_DML_rf = rep(0,S)
sd_sdim = rep(0,S)
est_cal_rf = rep(0,S)
est_cal_nn = rep(0,S)
est_cal_rfnn = rep(0,S)
est_DML_nn = rep(0,S)
est_DML_rf = rep(0,S)
est_sdim = rep(0,S)
est_dim = rep(0,S)
sd_dim = rep(0,S)
est_cal_rf_g = rep(0,S)
sd_cal_rf_g = rep(0,S)
est_cal_nn_g = rep(0,S)
sd_cal_nn_g = rep(0,S)
est_cal_rfnn_g = rep(0,S)
sd_cal_rfnn_g = rep(0,S)
for (s in 1:S){
print(s)
if (randomization_method == "PS") {
data = FUN(n,alpha0,alpha1,betavec0,betavec1,pi,sigma0,sigma1,p, weight,lambda)
}
else {
data = FUN(n,alpha0,alpha1,betavec0,betavec1,pi,sigma0,sigma1,p)
}
result = cal_rf_nn(data)
sd_cal_rf[s] = result$sd[1]
sd_cal_nn[s] = result$sd[2]
sd_cal_rfnn[s] = result$sd[3]
est_cal_rf[s] = result$est[1]
est_cal_nn[s] = result$est[2]
est_cal_rfnn[s] = result$est[3]
est_DML_nn[s] = result$est[5]
est_DML_rf[s] = result$est[4]
sd_DML_nn[s] = result$sd[5]
sd_DML_rf[s] = result$sd[4]
#est_dim[s] = mean(data$Y[data$A == 1]) - mean(data$Y[data$A == 0])
est_sdim[s] = result$est[6]
sd_sdim[s] = result$sd[6]
est_cal_rf_g[s] = result$est[7]
sd_cal_rf_g[s] = result$sd[7]
est_cal_nn_g[s] = result$est[8]
sd_cal_nn_g[s] = result$sd[8]
est_cal_rfnn_g[s] = result$est[9]
sd_cal_rfnn_g[s] = result$sd[9]
}
true_value = trueval(Model,alpha0,alpha1,betavec0,betavec1)
data_list <- list(est_cal_rf, est_cal_nn,est_cal_rfnn,
est_DML_nn, est_DML_rf, est_sdim,
est_cal_rf_g,est_cal_nn_g,est_cal_rfnn_g)
sd_data_list <- list(sd_cal_rf, sd_cal_nn,sd_cal_rfnn,
sd_DML_nn, sd_DML_rf, sd_sdim,
sd_cal_rf_g,sd_cal_nn_g,sd_cal_rfnn_g)
names = c("cal_rf", "cal_nn","cal_rfnn",
"AIPW_nn", "AIPW_rf", "sdim", "cal_rf_g","cal_nn_g","cal_rfnn_g")
file_name = sprintf("20250912_%s_n%s_%s.pdf", Model, n, randomization_method)
pdf(file_name, width = 10, height = 8)
boxplot(data_list, names=names, main = "Comparison of the Methods",
col = c("skyblue", "lightgreen", "lightpink", "lightyellow", "lightcoral","lightsalmon","lavender",
"lightseagreen","lightsteelblue","peachpuff"))
abline(h = true_value, col = "black", lty = 2,lwd=3)
legend("topright", legend = "Real Effect", col = "black", lty = 2, box.lwd = 0,lwd=3)
dev.off()
m = length(names)
df = data.frame(RMSE=rep(0,m), Bias=rep(0,m), SD=rep(0,m), SE=rep(0,m), CP=rep(0,m))
for (i in 1:length(names)){
df$Bias[i] = abs(mean(unlist(data_list[i]))-true_value)
print(paste("absolute error: ",names[i],": ",df$Bias[i],sep = ''))
}
for (i in 1:length(names)){
df$SD[i] = sd(unlist(data_list[i]))
print(paste("sd:",names[i],": ",df$SD[i],sep = ''))
}
for (i in 1:length(names)){
df$SE[i] = mean(unlist(sd_data_list[i]))
print(paste("estimated sd:",names[i],": ",df$SE[i],sep = ''))
}
for (i in 1:length(names)){
df$CP[i] = calculate_CP(true_value, unlist(data_list[i]), unlist(sd_data_list[i]))
print(paste("coverage probability:",names[i],": ",df$CP[i], sep = ''))
}
for (i in 1:length(names)){
df$RMSE[i] = mean((unlist(data_list[i])-true_value)^2)^0.5
print(paste("RMSE: ",names[i],": ",df$RMSE[i],sep = ''))
}
df$Bias <-round(df$Bias,3)
return(df)
}
final_df_list <- list()
randomization_methods = c("SRS","SBR","PS")
for (j in 1:3) {
df = run_simulation("Model6", 2000, randomization_methods[j])
final_df_list[[j]] <- df
}
final_df <- bind_cols(final_df_list)
print(final_df, digits=3, row.names = FALSE)
library(pls)
library(mda)
library(splines)
library(randomForest)
library(caret)
library(dplyr)
library(MASS)
library(glmnet)
library(kernlab)
library(nnet)
library(gbm)
library(rpart)
library(caretEnsemble)
library(elasticnet)
library(np)
library(earth)
library(neuralnet)
library(carat)
Rcpp::sourceCpp("vestimator.cpp")
source("estimators.R")
source("cal_estimator.R")
source("calibration.R")
source("createFolds_by_strat.R")
source("Model1.R")
source("Model2.R")
source("Model3.R")
source("Model4.R")
source("Model5.R")
source("Model6.R")
source("Model7.R")
source("Model8.R")
source("tables.R")
source("DML.R")
source("parallel.R")
RNGkind("L'Ecuyer-CMRG")
set.seed(0)
# mc.reset.stream()
run_simulation<- function(Model, n, randomization_method){
# Model = "Model8"
# Model = "Model5"
# n=500
#randomization_method = "SRS"
alpha0 = 1
alpha1 = 4
betavec0 = c(75,35,125,80)
betavec1 = c(100,80,60,40)
FUN = sim_fun(Model,randomization_method)
lambda = 0.75
weight = 1
omega = c(0.1,0.1,0.4,0.4)
sigma1 = 3
sigma0 = 1
pi = 0.5
p=30
S=300
sd_cal_rf = rep(0,S)
sd_cal_nn = rep(0,S)
sd_cal_rfnn = rep(0,S)
sd_DML_nn = rep(0,S)
sd_DML_rf = rep(0,S)
sd_sdim = rep(0,S)
est_cal_rf = rep(0,S)
est_cal_nn = rep(0,S)
est_cal_rfnn = rep(0,S)
est_DML_nn = rep(0,S)
est_DML_rf = rep(0,S)
est_sdim = rep(0,S)
est_dim = rep(0,S)
sd_dim = rep(0,S)
est_cal_rf_g = rep(0,S)
sd_cal_rf_g = rep(0,S)
est_cal_nn_g = rep(0,S)
sd_cal_nn_g = rep(0,S)
est_cal_rfnn_g = rep(0,S)
sd_cal_rfnn_g = rep(0,S)
for (s in 1:S){
print(s)
if (randomization_method == "PS") {
data = FUN(n,alpha0,alpha1,betavec0,betavec1,pi,sigma0,sigma1,p, weight,lambda)
}
else {
data = FUN(n,alpha0,alpha1,betavec0,betavec1,pi,sigma0,sigma1,p)
}
result = cal_rf_nn(data)
sd_cal_rf[s] = result$sd[1]
sd_cal_nn[s] = result$sd[2]
sd_cal_rfnn[s] = result$sd[3]
est_cal_rf[s] = result$est[1]
est_cal_nn[s] = result$est[2]
est_cal_rfnn[s] = result$est[3]
est_DML_nn[s] = result$est[5]
est_DML_rf[s] = result$est[4]
sd_DML_nn[s] = result$sd[5]
sd_DML_rf[s] = result$sd[4]
#est_dim[s] = mean(data$Y[data$A == 1]) - mean(data$Y[data$A == 0])
est_sdim[s] = result$est[6]
sd_sdim[s] = result$sd[6]
est_cal_rf_g[s] = result$est[7]
sd_cal_rf_g[s] = result$sd[7]
est_cal_nn_g[s] = result$est[8]
sd_cal_nn_g[s] = result$sd[8]
est_cal_rfnn_g[s] = result$est[9]
sd_cal_rfnn_g[s] = result$sd[9]
}
true_value = trueval(Model,alpha0,alpha1,betavec0,betavec1)
data_list <- list(est_cal_rf, est_cal_nn,est_cal_rfnn,
est_DML_nn, est_DML_rf, est_sdim,
est_cal_rf_g,est_cal_nn_g,est_cal_rfnn_g)
sd_data_list <- list(sd_cal_rf, sd_cal_nn,sd_cal_rfnn,
sd_DML_nn, sd_DML_rf, sd_sdim,
sd_cal_rf_g,sd_cal_nn_g,sd_cal_rfnn_g)
names = c("cal_rf", "cal_nn","cal_rfnn",
"AIPW_nn", "AIPW_rf", "sdim", "cal_rf_g","cal_nn_g","cal_rfnn_g")
file_name = sprintf("20250912_%s_n%s_%s.pdf", Model, n, randomization_method)
pdf(file_name, width = 10, height = 8)
boxplot(data_list, names=names, main = "Comparison of the Methods",
col = c("skyblue", "lightgreen", "lightpink", "lightyellow", "lightcoral","lightsalmon","lavender",
"lightseagreen","lightsteelblue","peachpuff"))
abline(h = true_value, col = "black", lty = 2,lwd=3)
legend("topright", legend = "Real Effect", col = "black", lty = 2, box.lwd = 0,lwd=3)
dev.off()
m = length(names)
df = data.frame(RMSE=rep(0,m), Bias=rep(0,m), SD=rep(0,m), SE=rep(0,m), CP=rep(0,m))
for (i in 1:length(names)){
df$Bias[i] = abs(mean(unlist(data_list[i]))-true_value)
print(paste("absolute error: ",names[i],": ",df$Bias[i],sep = ''))
}
for (i in 1:length(names)){
df$SD[i] = sd(unlist(data_list[i]))
print(paste("sd:",names[i],": ",df$SD[i],sep = ''))
}
for (i in 1:length(names)){
df$SE[i] = mean(unlist(sd_data_list[i]))
print(paste("estimated sd:",names[i],": ",df$SE[i],sep = ''))
}
for (i in 1:length(names)){
df$CP[i] = calculate_CP(true_value, unlist(data_list[i]), unlist(sd_data_list[i]))
print(paste("coverage probability:",names[i],": ",df$CP[i], sep = ''))
}
for (i in 1:length(names)){
df$RMSE[i] = mean((unlist(data_list[i])-true_value)^2)^0.5
print(paste("RMSE: ",names[i],": ",df$RMSE[i],sep = ''))
}
df$Bias <-round(df$Bias,3)
return(df)
}
final_df_list <- list()
randomization_methods = c("SRS","SBR","PS")
for (j in 1:3) {
df = run_simulation("Model5", 500, randomization_methods[j])
final_df_list[[j]] <- df
}
final_df <- bind_cols(final_df_list)
print(final_df, digits=3, row.names = FALSE)
library(haven)
library(pls)
library(mda)
library(splines)
library(randomForest)
library(caret)
library(dplyr)
library(MASS)
library(glmnet)
library(kernlab)
library(nnet)
library(gbm)
library(rpart)
library(caretEnsemble)
library(elasticnet)
library(np)
library(earth)
library(neuralnet)
library(carat)
Rcpp::sourceCpp("vestimator.cpp")
source("estimators.R")
source("cal_estimator.R")
source("calibration.R")
source("createFolds_by_strat.R")
source("Model1.R")
source("Model2.R")
source("Model3.R")
source("Model4.R")
source("Model5.R")
source("Model6.R")
source("Model7.R")
source("Model8.R")
source("tables.R")
source("DML.R")
source("parallel.R")
RNGkind("L'Ecuyer-CMRG")
set.seed(0)
# mc.reset.stream()
data <- read_dta("Data/Data_Uganda/glaseu_four_rounds.dta")
na_counts <- colSums(is.na(data))
data_clean <- data[, na_counts <= 200]
dim(data_clean)
colnames(data_clean)
data_clean$b_amountsaved_resp_tot
data_clean$b_amountsaved_resp_tot2
data_clean$b_amountsaved_resp_tot2[data_clean$treated == 0]
mean(data_clean$b_amountsaved_resp_tot2[data_clean$treated == 0])
mean(data_clean$b_amountsaved_resp_tot2[data_clean$treated == 1])
data_clean$b_amountsaved_resp_tot2[1:5]
data_clean$b_amountsaved_resp_tot[1:5]
source("Model5.R")
data2 = read_dta("Data/Data_Uganda/glaseu_transactions.dta")
data2
data2$`_merge`
data_clean$depvar
data_clean$e_amountsaved_resp_tot
data_clean$b_amountsaved_resp_tot
data_clean$b_amountsaved_resp_tot[1:5]
data_clean$e_amountsaved_resp_tot[1:5]
mean(data_clean$e_amountsaved_resp_tot2[data_clean$treated == 1])
mean(data_clean$e_amountsaved_resp_tot[data_clean$treated == 1])
data_clean$e_amountsaved_resp_tot
data_clean$e_amountsaved_resp_tot[is.na(data_clean$e_amountsaved_resp_tot) == FALSE]
length(data_clean$e_amountsaved_resp_tot[is.na(data_clean$e_amountsaved_resp_tot) == FALSE])
data <- read_dta("Data/Data_Uganda/glaseu_four_rounds.dta")
na_counts <- colSums(is.na(data))
data_clean <- data[is.na(data$e_amountsaved_resp_tot) == FALSE, na_counts <= 200]
dim(data_clean)
mean(data_clean$e_amountsaved_resp_tot[data_clean$treated == 1])
mean(data_clean$e_amountsaved_resp_tot[data_clean$treated == 0])
195986.4-180492.1
15494.3/data_clean$e_amountsaved_resp_tot[1] * data_clean$e_amountsaved_resp_tot2[1]
15494.3/data_clean$b_amountsaved_resp_tot[1] * data_clean$b_amountsaved_resp_tot2[1]
data_clean$numrounds
data <- read_dta("Data/Data_Uganda/glaseu_four_rounds.dta")
data <- read_dta("Data/Data_Uganda/glaseu_four_rounds.dta")
library(haven)
library(pls)
library(mda)
library(splines)
library(randomForest)
library(caret)
library(dplyr)
library(MASS)
library(glmnet)
library(kernlab)
library(nnet)
library(gbm)
library(rpart)
library(caretEnsemble)
library(elasticnet)
library(np)
library(earth)
library(neuralnet)
library(carat)
Rcpp::sourceCpp("vestimator.cpp")
source("estimators.R")
source("cal_estimator.R")
source("calibration.R")
source("createFolds_by_strat.R")
source("Model1.R")
source("Model2.R")
source("Model3.R")
source("Model4.R")
source("Model5.R")
source("Model6.R")
source("Model7.R")
source("Model8.R")
source("tables.R")
source("DML.R")
source("parallel.R")
RNGkind("L'Ecuyer-CMRG")
set.seed(0)
# mc.reset.stream()
data <- read_dta("Data/Data_Uganda/glaseu_four_rounds.dta")
na_counts <- colSums(is.na(data))
data_clean <- data[is.na(data$e_amountsaved_resp_tot) == FALSE, na_counts <= 200]
dim(data_clean)
data2 = read_dta("Data/Data_Uganda/glaseu_transactions.dta")
data_clean$mv1_amountsaved_resp_tot
?rq
?rq
?qr
